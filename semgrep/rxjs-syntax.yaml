rules:

  - id: combineLatest-not-combining
    pattern: combineLatest([$SINGLE_EXPRESSION])
    # TODO: waiting for https://github.com/returntocorp/semgrep/issues/1721 -- in release 0.29.0
    #fix:  $SINGLE_EXPRESSION
    fix:  $SINGLE_EXPRESSION.
    message: combineLatest is not needed with a single argument
    languages: [ts]
    severity: WARNING

  - id: observables-from-select-or-pipe-not-ending-with-dollar-sign
    patterns:
    - pattern-regex: '\w+\s*(:.+?)?=.*?(select|pipe)'
    - pattern-either:
      - pattern-inside: $VAR = $EXPR.select(...);
      - pattern-inside: $VAR = $EXPR.pipe(...);
    - pattern-not-inside: $VAR = d3.select(...);
    message: |
      Observable variable should end with a dollar sign.
    languages: [ts]
    severity: ERROR

  - id: observables-from-values-not-ending-with-dollar-sign
    patterns:
    - pattern-regex: '\w+\s*(:.+?)?=\s*(observableOf|of)'
    - pattern-either:
      - pattern-inside: $VAR = observableOf(...)
      - pattern-inside: $VAR = of(...)
    message: |
      Observable variable should end with a dollar sign.
    languages: [ts]
    severity: ERROR

  # TODO: waiting for https://github.com/returntocorp/semgrep/issues/1861 -- likely in release 0.29.0
  # - id: subscriptions-only-during-initialization
  #   patterns:
  #   - pattern: |
  #       $EXPR.subscribe(...);
  #   - pattern-not-inside: |
  #       class $CLASS {
  #         ...
  #         constructor(...) {
  #           ...
  #           $EXPR.subscribe(...);
  #           ...
  #         }
  #         ...
  #       }
  #   - pattern-not-inside: |
  #       class $CLASS {
  #         ...
  #         ngOnInit() {
  #           ...
  #           $EXPR.subscribe(...);
  #           ...
  #         }
  #         ...
  #       }
  #   - pattern-not-inside: |
  #       class $CLASS {
  #         ...
  #         ngAfterContentInit() {
  #           ...
  #           $EXPR.subscribe(...);
  #           ...
  #         }
  #         ...
  #       }
  #   - pattern-not-inside: |
  #       class $CLASS {
  #         ...
  #         ngOnInit() {
  #           ...
  #           this.$FUNC(...);
  #           ...
  #         }
  #         ...
  #         $FUNC(...) {
  #           ...
  #           $EXPR.subscribe(...);
  #           ...
  #         }
  #         ...
  #       }
  #   - pattern-not-inside: |
  #       $SUB_EXPR.pipe(first()).subscribe(...);
  #   message: subscribe() should only be in ngOnInit or constructor
  #   languages: [ts]
  #   severity: ERROR
